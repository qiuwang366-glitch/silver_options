# SHFE白银期权分析工具 - 快速使用指南

## ✅ 已解决的问题

### 原问题
- 白银期货价格在**19000**左右
- 原程序从**6000**开始下载期权，导致数据不全且不相关
- 只能下载十几个期权价格，无法进行有效分析

### 解决方案
✨ **新程序 `analysis_enhanced.ipynb`** 现在可以:
- 自动识别当前期货价格（例如19000）
- 只获取**ATM附近±15%**的期权（16150-21850）
- 确保每侧至少**15个执行价**
- 获得30-40个高度相关的期权合约

---

## 🚀 快速开始

### 1. 打开Jupyter Notebook
```bash
cd /home/user/silver_options
jupyter notebook analysis_enhanced.ipynb
```

### 2. 运行所有单元格
点击菜单: **Cell → Run All**

或者按快捷键: **Shift + Enter** 逐个运行

### 3. 查看结果
程序会自动生成：
- 📊 期货市场快照
- 📈 ATM附近的期权链（自动过滤！）
- 🎨 SABR模型校准结果
- 📉 波动率微笑曲线
- 🌐 **3D波动率曲面**（新功能！）
- 📊 Greeks分析仪表盘（新功能！）
- 💹 做市商Gamma暴露分析
- 📝 交易策略建议

---

## 🎯 核心改进

### 1. 智能期权筛选
```python
# 原程序：获取所有期权（可能有几百个，从6000开始）
options = fetcher.fetch_option_chain(UNDERLYING)

# 新程序：只获取ATM附近相关期权
options = fetcher.fetch_option_chain_atm_focused(
    underlying_code="AG2604.SHF",
    spot_price=19000,           # 自动获取实时价格
    atm_range_pct=0.15,         # ±15%范围
    min_strikes_per_side=15     # 每侧至少15个执行价
)
# 结果：30-40个高度相关的期权（16000-22000范围）
```

### 2. 3D波动率曲面
- **X轴**: 执行价（16000-22000）
- **Y轴**: 到期时间（1周-6个月）
- **Z轴**: 隐含波动率（%）
- **交互**: 可以旋转、缩放、查看具体数值

### 3. 完整的Greeks分析
四个图表：
- Delta Profile（看涨/看跌）
- Gamma Profile（曲率最大点）
- Vega Profile（波动率敏感性）
- Theta Profile（时间衰减）

### 4. 更详细的期权分析
- **隐含波动率结构**: 按moneyness分组统计
- **Put-Call Parity**: 检查套利机会
- **偏度指标**:
  - Risk Reversal（25Δ）
  - Butterfly（25Δ）
- **SABR相关性**: ρ参数解读

---

## 📊 输出示例

### 数据获取阶段
```
═══════════════════════════════════════════════════════════════════════
FETCHING MARKET DATA: AG2604.SHF
═══════════════════════════════════════════════════════════════════════

📊 FUTURES SNAPSHOT
   Price:              19,000.00
   Bid/Ask:            18,995 / 19,005
   Volume:                45,000
   Open Interest:        180,000

🔍 Fetching option chain for AG2604.SHF...
   ATM Price: 19,000
   Target Range: ±15% [16,150 - 21,850]
   ✓ Filtered to 62 contracts (31 unique strikes)    ← 这里！只取相关的
   Strike Range: 16,200 - 21,800

📈 OPTION CHAIN SUMMARY
   Total Contracts:  62
   Liquid Contracts: 58
```

### 波动率分析
```
═══════════════════════════════════════════════════════════════════════
VOLATILITY SKEW METRICS
═══════════════════════════════════════════════════════════════════════

ATM Strike:        19,000
ATM IV:             22.34%

25Δ Call Strike:   20,200
25Δ Call IV:        20.15%

25Δ Put Strike:    17,800
25Δ Put IV:         24.89%

────────────────────────────────────────────────────────────────────────
Risk Reversal:      -4.74 vol pts    ← 看跌偏度
Butterfly:          +0.18 vol pts    ← 凸性溢价
```

### 策略建议
```
═══════════════════════════════════════════════════════════════════════
4. ACTIONABLE TRADING STRATEGIES
═══════════════════════════════════════════════════════════════════════

   📉 PRIMARY STRATEGY: Bearish Volatility Expansion

      Market Setup:
      • Strong put skew (-4.7) + Negative GEX
      • Downside acceleration risk underpriced

      Recommended Trade:
      • BUY 17,800 / 17,300 Put Spread
      • Target: Break below 17,600
      • Stop: Above 19,000

      Profit Catalyst:
      If spot breaches 17,600, dealer hedge selling
      creates non-linear price acceleration.
```

---

## ⚙️ 参数调整

### 调整ATM范围
在notebook顶部找到这些参数：
```python
UNDERLYING = "AG2604.SHF"      # 可以改成AG2605等
ATM_RANGE_PCT = 0.15           # 改成0.20则获取±20%范围
MIN_STRIKES = 15               # 改成20则每侧至少20个执行价
```

### 修改到期时间
```python
# 方法1: 手动设置天数
T = 90 / 365  # 90天

# 方法2: 计算实际到期日
from datetime import datetime
expiry_date = datetime(2026, 4, 15)  # AG2604的实际到期日
T = (expiry_date - datetime.now()).days / 365
```

### 调整SABR模型
```python
# 修改β参数（CEV指数）
sabr_params = SABRModel.calibrate(
    strikes=...,
    market_vols=...,
    forward=futures.price,
    time_to_expiry=T,
    beta=0.5  # 改成0.5更接近Normal模型，1.0是纯Lognormal
)
```

---

## 🎨 新增可视化

### 1. 波动率微笑（4象限图）
- **左上**: 执行价空间的Smile
- **右上**: Moneyness空间的Smile
- **左下**: 模型拟合质量
- **右下**: 残差分析

### 2. 3D波动率曲面
- 交互式3D图表
- 鼠标拖动旋转
- 滚轮缩放
- 悬停查看数值

### 3. Greeks仪表盘（2×2）
- Delta、Gamma、Vega、Theta
- 每个都有执行价标记线
- 显示ATM位置

### 4. GEX图表（上下两层）
- **上层**: Net GEX柱状图（红/蓝）
- **下层**: Call/Put OI分布

---

## 📖 如何解读结果

### Risk Reversal (RR)
- **RR < -2**: 强烈看跌偏度 → 市场担心下跌
- **-2 < RR < -1**: 温和看跌偏度
- **-1 < RR < +1**: 中性
- **RR > +1**: 看涨偏度 → 市场担心上涨

### Butterfly (BF)
- **BF > 2**: 尾部风险溢价高 → 市场预期大波动
- **0 < BF < 2**: 正常
- **BF < 0**: Wings便宜（罕见）

### SABR ρ (相关系数)
- **ρ < -0.3**: 杠杆效应 → 价格跌时波动率涨（正常）
- **-0.3 < ρ < 0.3**: 中性
- **ρ > 0.3**: 逆杠杆 → 价格涨时波动率涨（可能挤压）

### Dealer GEX
- **负GEX**: 做市商short gamma → 价格波动放大
- **正GEX**: 做市商long gamma → 价格波动压制
- **接近零**: 过渡区域 → 可能regime转换

---

## ⚠️ 重要提示

### 数据质量
1. **实时性**: Wind数据有1-2秒延迟
2. **准确性**: 检查bid-ask价差，过宽则数据可能不新鲜
3. **持仓量**: OI是日级数据（非实时）

### 模型限制
1. **SABR假设连续对冲**: 实际有交易成本
2. **GEX假设做市商是对手方**: 不总是成立
3. **β参数固定**: 实际可能随时间变化

### 交易风险
1. **隔夜风险**: 商品市场容易跳空
2. **流动性**: 检查实际可成交量
3. **保证金**: 期权卖方需要大量保证金
4. **滑点**: 大单会冲击价格

---

## 🔧 故障排查

### Wind API连接失败
```
ERROR: Data fetch failed - Wind API Error: ...

解决方案:
1. 检查Wind客户端是否运行
2. 运行 w.start() 手动连接
3. 检查API权限和到期时间
4. 联系Wind技术支持
```

### 没有足够的期权数据
```
WARNING: No options found in range!

解决方案:
1. 检查合约代码是否正确（AG2604.SHF）
2. 确认合约还未到期
3. 增大ATM_RANGE_PCT（例如改成0.25）
4. 减少MIN_STRIKES（例如改成10）
```

### SABR校准失败
```
Calibration RMSE: 0.1234 (12.34% vol points)

解决方案:
1. 检查市场数据质量
2. 尝试不同的β值（0.5, 0.7, 0.9）
3. 增加校准用的期权数量
4. 检查是否有异常IV值
```

---

## 📞 获取帮助

### 文档
- **详细文档**: 查看 `README_ENHANCED.md`
- **原版说明**: 查看 `README.md`

### 支持渠道
1. **查看示例输出**: notebook中的synthetic data部分
2. **阅读注释**: 代码中有详细的docstrings
3. **提交Issue**: 在GitHub repository开issue

---

## 🎓 进阶使用

### 保存分析结果
```python
# 在notebook最后添加这些代码

# 保存SABR参数
import json
with open('sabr_params.json', 'w') as f:
    json.dump({
        'alpha': sabr_params.alpha,
        'beta': sabr_params.beta,
        'rho': sabr_params.rho,
        'nu': sabr_params.nu,
        'forward': sabr_params.f,
        'time': sabr_params.t,
        'timestamp': datetime.now().isoformat()
    }, f, indent=2)

# 导出Greeks数据
greeks_df.to_csv('greeks_export.csv', index=False)

# 导出GEX数据
gex_df.to_csv('gex_export.csv', index=False)
```

### 批量分析多个合约
```python
contracts = ['AG2604.SHF', 'AG2605.SHF', 'AG2606.SHF']
results = {}

for contract in contracts:
    futures = fetcher.fetch_futures_snapshot(contract)
    options = fetcher.fetch_option_chain_atm_focused(
        contract, futures.price
    )
    # ... 后续分析
    results[contract] = {...}
```

### 定时运行
```bash
# 创建cron job每天运行分析
# crontab -e
0 9 * * 1-5 cd /home/user/silver_options && jupyter nbconvert --execute analysis_enhanced.ipynb
```

---

## 📝 更新日志

### v2.0 (Enhanced) - 2026-01-07
- ✅ ATM聚焦的期权链获取
- ✅ 3D波动率曲面可视化
- ✅ 完整Greeks仪表盘
- ✅ 增强的策略生成
- ✅ Put-Call Parity检查
- ✅ IV结构分析
- ✅ 风险管理框架
- ✅ 中文文档

### v1.0 (Original) - 2026-01-06
- ✅ SABR模型校准
- ✅ 基础GEX分析
- ✅ Skew metrics
- ✅ 基础可视化

---

**祝交易顺利！记得风险管理！** 🚀📈

如有问题，请参考 `README_ENHANCED.md` 或提交GitHub Issue。
